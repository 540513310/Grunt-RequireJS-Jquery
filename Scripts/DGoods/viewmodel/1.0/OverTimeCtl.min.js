/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerytmpl","NavibarCtl","../utils/SysUrl","../utils/Common","../utils/ConsumeLevel","../utils/SysConfig","../moduler/rs_NewRequire","../moduler/rs_RequireMyGoods","../viewmodel/ReqMyGdViewModel","../viewmodel/NewRequireViewModel","../viewmodel/Dis_DelRequireViewModel"],function(a,b,c,d,e,f,g,h,i,j,k){var l=function(b){this.tempPanel=a(".findD-none"),this.LeftPanel=a(".vien-left"),this.RightPanel=a(".vien-right"),this.lbPunishCount=a(".LbPushCount"),this.lbOfferCount=a(".LbOfferCount"),this.lbStartTime=a(".LbStartTime"),this.lbSeries=a(".LbSeries"),this.lbDetail=a(".LbDetail"),this.TotalOverTime=0,this.TmplRequireMarkUp=a("#OverTimeTemplate"),this.RequireMarkUp=a(".OverTimeMarkUp"),this.OverTimeModel=new j,this.LoginUser=b,this.DeleteRequireModel=new k,this.RequirePageNo=window.SysInfo.Paging.VisiblePages,this.RequirePageSize=window.SysInfo.Paging.DftPageSize,this.CurrentRequireID=null,this.CurrentOfferID=null,this.CurrentRequireLst=[],this.CurrentRequire={},this.IsFirstQuery=!0,this.Address={city:"无锡市",province:"江苏省",district:""},this.init()};return l.prototype={init:function(){var b=this;"object"==typeof b.LoginUser&&void 0!=b.LoginUser||(window.location=d.getUrl("/Account/Login?ReturnUrl="+window.location.pathname)),b.CurrentRequireLst=[];var e=new c(b.LoginUser);e.buildNavibar(function(c){c.EXPIRED+c.CANCELED==0?b.tempPanel.css("display","block"):(b.LeftPanel.css("display","block"),b.RightPanel.css("display","block")),b.NavibarLoaded=!0,a(".TotalOverTime").first().closest("dd").addClass("active")})},setCurrent:function(){var a=this;a.lbPunishCount.text(a.CurrentRequire.PUSHCOUNT),a.lbOfferCount.text(a.CurrentRequire.OFFERCOUNT),a.lbStartTime.text(a.CurrentRequire.STARTTIME),a.lbSeries.text(a.CurrentRequire.SERIES+"/"+a.CurrentRequire.MATERIAL+"/"+a.CurrentRequire.SURFACE),a.lbDetail.text(a.CurrentRequire.DETAIL+"      交货地点:"+a.CurrentRequire.DELIVERY),a.bindRightEvents()},queryOverTime:function(){var a=this;a.OverTimeModel.setter(a.LoginUser.DDUserId,"B,D","B",a.RequirePageNo,a.RequirePageSize),a.OverTimeModel.getMyGoods(function(b){1==b.isSuccess&&b.Data.DATAS.length>0&&(1==a.IsFirstQuery&&(a.IsFirstQuery=!1,b.Data.DATAS[0].ISACTIVE="active",a.CurrentRequire=b.Data.DATAS[0],a.CurrentRequireID=b.Data.DATAS[0].REQUIREID,a.setCurrent()),a.CurrentRequireLst=a.CurrentRequireLst.concat(b.Data.DATAS),a.TmplRequireMarkUp.tmpl(b.Data.DATAS).appendTo(".vien-left"),a.bindLeftEvents())})},bindLeftEvents:function(){var b=this;b.LeftPanel.find("li").unbind("click"),b.LeftPanel.find("li").click(function(){b.LeftPanel.find("li").removeClass("active"),a(this).addClass("active"),b.CurrentRequireID=a(this).attr("data-id");for(var c=0;c<b.CurrentRequireLst.length;c++)if(b.CurrentRequireLst[c].REQUIREID==b.CurrentRequireID){b.CurrentRequire=b.CurrentRequireLst[c];break}b.setCurrent()});var c=!1;a(b.LeftPanel).scroll(function(){if(!c&&a(b.LeftPanel).scrollTop()>b.LeftPanel.prop("scrollHeight")-b.LeftPanel.height()-20&&(c=!0,b.TotalOverTime=parseInt(a(".TotalOverTime").last().text()),b.TotalOverTime-b.CurrentRequireLst.length>0)){var d='<li class="loadMore" style="text-align:center;position:absolute;bottom: 21px;width: 54.4%;z-index: 100;background: white;">信息加载中...</li>';a(d).insertAfter(b.LeftPanel.find("li").last()),height=a(".loadMore").height(),a(".loadMore").fadeOut(1e3,function(){b.RequirePageNo+=1,b.queryOverTime(),a(this).remove()})}})},bindRightEvents:function(){var b=this;b.ConfirmQuotedBtn=a(".menu_btn.menu_btn_sub.btn-intention"),b.ConfirmQuotedBtn.unbind("click"),b.ConfirmQuotedBtn.on("click",function(a){b.newRequire(this)})},newRequire:function(a){var b=this;window.open(d.getUrl("/DGoods/Deliver/Delivering?requireId="+b.CurrentRequireID),"_self")}},l});