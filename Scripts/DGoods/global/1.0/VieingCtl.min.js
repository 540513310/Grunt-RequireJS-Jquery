/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerytmpl","jquerynotify","NavibarCtl","../utils/SysUrl","../utils/Common","../utils/ModelDailog","../utils/SysConfig","../utils/ConsumeLevel","../moduler/rs_QuoteGoods","../viewmodel/Require_QuoteViewModel","../viewmodel/QuoteGoodsViewModel","../viewmodel/QuotedInfoViewModel","../viewmodel/DismissQuoteViewModel"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=function(b,c){this.GeoLocation=c,this.LoginUser=b,this.QuoteGoods=function(){},this.QuoteGoods.prototype=j.Req,this.QuotingModel=new m,this.QuotPageSize=window.SysInfo.Paging.DftPageSize,this.QuotPageNo=window.SysInfo.Paging.VisiblePages,this.QuoteModel=new l,this.DimissModel=new n,this.tempPanel=a(".findD-none"),this.TmplQuoteTemplate=a("#VieTemplate"),this.QuotedPannel=a(".quote-ul"),this.TotalVied=0,this.CurrentQuotingLst=[],this.CurrentQuotingID=null,this.CurrentQuoting={},this.navibar=new d(b),this.Address={city:"无锡市",province:"江苏省",district:""},this.CurrentLt="31.57003745",this.CurrentLg="120.30545590",this.init()};return o.prototype={init:function(){var b=this;"object"==typeof b.LoginUser&&void 0!=b.LoginUser||(window.location=e.getUrl("/Account/Login?ReturnUrl="+window.location.pathname)),b.navibar.buildNavibar(function(c){c.BIDDED>0&&0==c.STATE&&b.beginQuery(),0==c.BIDDED||0!=c.STATE?b.tempPanel.css("display","block"):b.QuotedPannel.css("display","block"),b.navibar.buildScroll(),a(".TotalVied").first().closest("dd").addClass("active")}),b.CurrentQuotingLst=[]},bindEvent:function(){var b=this;a(function(){new BMap.Geolocation;b.GeoLocation.getCurrentPosition(function(a){this.getStatus()==BMAP_STATUS_SUCCESS?(b.CurrentLt=a.latitude,b.CurrentLg=a.longitude,b.Address=a.address):alert("failed"+this.getStatus())},{enableHighAccuracy:!0})}),b.QuotedPannel.find("li").unbind("click"),b.QuotedPannel.find("li").click(function(){b.QuotedPannel.find("li").removeClass("active"),a(this).addClass("active"),b.CurrentQuotingID=a(this).attr("data-id");for(var c=0;c<b.CurrentQuotingLst.length;c++)if(b.CurrentQuotingLst[c].REQUIREID==b.CurrentQuotingID){b.CurrentQuoting=b.CurrentQuotingLst[c];break}}),a(".btn-Change").unbind("click"),a(".btn-Change ").click(function(){var b=a(this).closest("li");a(".quote-ul li").removeClass("active"),b.addClass("active"),b.find(".quote-change").css("display","none"),b.find(".quote-confirm").css("display","block"),b.find(".QuotedPrice").focus()}),a(".QuotedPrice").keydown(function(b){-1!==a.inArray(b.keyCode,[46,8,9,27,13,110,190])||65==b.keyCode&&(b.ctrlKey===!0||b.metaKey===!0)||b.keyCode>=35&&b.keyCode<=40||(b.shiftKey||b.keyCode<48||b.keyCode>57)&&(b.keyCode<96||b.keyCode>105)&&(a(this).notify("请输入数字",{position:"right",autoHideDelay:1e3,hideDuration:200,className:"error"}),b.preventDefault())}),a(".btn-Cancel").unbind("click"),a(".btn-Cancel").click(function(){var b=a(this).closest("li");b.find(".quote-change").css("display","block"),b.find(".quote-confirm").css("display","none")}),a(".btn-Submit").unbind("click"),a(".btn-Submit").click(function(){b.quotingGoods(a(this).parent())}),a(".btn-Dimiss").unbind("click"),a(".btn-Dimiss").click(function(){b.DimissGoods(a(this).parent())});var c=!1;b.TotalVied=parseInt(a(".TotalVied").last().text()),a(b.QuotedPannel).scroll(function(){if(!c&&a(b.QuotedPannel).scrollTop()>b.QuotedPannel.prop("scrollHeight")-b.QuotedPannel.height()-20&&(c=!0,b.TotalVied-b.CurrentQuotingLst.length>0)){var d='<li class="loadMore" style="text-align:center;position:absolute;bottom: 21px;width: 54.4%;z-index: 100;background: white;">信息加载中...</li>';a(d).insertAfter(b.QuotedPannel.find("li").last()),b.QuotPageNo+=1,b.beginQuery(),a(".loadMore").fadeOut(2e3,function(){a(this).remove()})}})},beginQuery:function(){var a=this;a.QuotingModel.setter(a.LoginUser.DDUserId,"A",a.QuotPageNo,a.QuotPageSize),a.QuotingModel.quoteGoods(function(b){if(1==b.isSuccess&&b.Data.DATAS.length>0){for(var c=0;c<b.Data.DATAS.length;c++)b.Data.DATAS[c].ImageLst=i(b.Data.DATAS[c].BCREDIT,!0);b.Data.DATAS[0].ISACTIVE="active",a.CurrentQuoting=b.Data.DATAS[0],a.CurrentQuotingLst=a.CurrentQuotingLst.concat(b.Data.DATAS),a.TmplQuoteTemplate.tmpl(b.Data.DATAS).appendTo(".quote-ul"),a.bindEvent()}})},quotingGoods:function(a){var b=this,c=a.closest(".VieingMarkUp"),d=b.CurrentLt+","+b.CurrentLg+",["+b.Address.province+","+b.Address.city+","+b.Address.district+",ADDR]",e=a.find(".QuotedNote").val(),g=parseFloat(a.find(".QuotedPrice").val());if(1==isNaN(g)||0==g.length){var h={title:"提示",desc:"价格信息不正确，请检查后再发送！",button:{enterBtn:{text:"关闭"}}},i=new f.CustDialog(h);return void i.showNoCertDialog()}e==a.find(".QuotedNote").attr("placeholder")&&(e=""),b.QuoteModel.setter(b.LoginUser.DDUserId,b.CurrentQuoting.REQUIREID,b.CurrentQuoting.OFFERID,g,0,e,d),b.QuoteModel.quoteGoods(function(d){1==d.isSuccess&&0==d.Data.STATE&&(100>=g&&(g=1e3*g),f.WriteAnalyze("抢单中-改价",{"求购类型":b.CurrentQuoting.SERIES,"报价信息":g}),c.find(".quote-right").notify("改价成功！",{position:"left",className:"success",autoHideDelay:1500}),c.find(".LbPrice").text(g),c.find(".LbDesc").text(e),a.closest(".VieingMarkUp").slideUp("fast",function(){c.find(".btn-Cancel").trigger("click")}),a.closest(".VieingMarkUp").slideDown("normal"))})},DimissGoods:function(b){var c=this,d={title:"DD找货提示",desc:"您确认撤销该报价信息吗？",button:{cleanBtn:{visable:!0,text:"取消"},enterBtn:{text:"确认",url:"",onConfrim:function(){c.DimissModel.setter(c.LoginUser.DDUserId,c.CurrentQuoting.OFFERID),c.DimissModel.quotedDimmiss(function(d){0==d.Data.STATE&&(f.WriteAnalyze("抢单中-撤单",{"求购类型":c.CurrentQuoting.SERIES}),a(b).notify("撤价成功！",{position:"left",className:"success",autoHideDelay:1500}),setTimeout(function(){b.closest(".VieingMarkUp").slideUp("normal",function(){a(this).remove()}),c.TotalVied-=1,a(".TotalVied").text(c.TotalVied)},2e3))})}}}},e=new f.CustDialog(d);e.showNoCertDialog()}},o});