/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerytmpl","jquerynotify","jqueryhisotry","NavibarCtl","../utils/SysUrl","../utils/ModelDailog","../utils/Common","../utils/SysConfig","../utils/ConsumeLevel","../moduler/rs_QuoteGoods","../viewmodel/Require_QuoteViewModel","../viewmodel/QuoteGoodsViewModel","../viewmodel/IgnoreRequireViewModel"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=function(b,c,d){this.GeoLocation=c,this.LoginUser=b,this.QuoteGoods=function(){},this.QuoteGoods.prototype=k.Req,this.QuotingModel=new l,this.QuotPageSize=window.SysInfo.Paging.DftPageSize,this.QuotPageNo=window.SysInfo.Paging.VisiblePages,this.QuotGoodsModel=new m,this.IngnoreGoodsModel=new n,this.tempPanel=a(".findD-none"),this.TmplQuoteTemplate=a("#QuotedTemplate"),this.QuotedPannel=a(".quote-ul"),this.TotalVieing=0,this.TotalVied=0,this.CurrentQuotingLst=[],this.CurrentQuotingID=null,this.CurrentQuoting={},this.CurrentListPosition=-1,this.Address={city:"无锡市",province:"江苏省",district:""},this.CurrentLt="31.57003745",this.CurrentLg="120.30545590",this.IsFirstQuery=!0,this.IsDDUser=!0,this.navibar=new e(b),"undefined"!=typeof d&&(this.CurrentQuotingID=d),this.init()};return o.prototype={init:function(){var b=this;b.navibar.isIdentify(),b.navibar.buildNavibar(function(c){0!=c.STATE&&(b.IsDDUser=!1),b.beginQuery(),b.navibar.buildScroll(),a(".TotalViening").first().closest("dd").addClass("active")}),History.pushState("","抢单- 去报价- 东方商城","/DGoods/VieOrder/Quoted"),a(function(){new BMap.Geolocation;b.GeoLocation.getCurrentPosition(function(a){this.getStatus()==BMAP_STATUS_SUCCESS?(b.CurrentLt=a.latitude,b.CurrentLg=a.longitude,b.Address=a.address):alert("failed"+this.getStatus())},{enableHighAccuracy:!0})})},bindEvent:function(){var b=this;h.PlaceHolder(),b.IsFirstQuery&&(0==b.CurrentQuotingLst.length?b.tempPanel.css("display","block"):b.QuotedPannel.css("display","block")),b.IsDDUser||a(".TotalViening").text(b.CurrentQuotingLst.length),b.IsFirstQuery=!1,b.QuotedPannel.find("li").unbind("click"),b.QuotedPannel.find("li").click(function(){b.QuotedPannel.find("li").removeClass("active"),a(this).addClass("active"),b.CurrentQuotingID=a(this).attr("data-id");for(var c=0;c<b.CurrentQuotingLst.length;c++)if(b.CurrentQuotingLst[c].REQUIREID==b.CurrentQuotingID){b.CurrentQuoting=b.CurrentQuotingLst[c],b.CurrentListPosition=c;break}}),a(".btn-Quoting").unbind("click"),a(".btn-Quoting").click(function(){b.quotingGoods(this,a(this).closest("form"))}),a(".btn-Ingnore").unbind("click"),a(".btn-Ingnore").click(function(){b.ingnoreGoods(this,a(this).closest("form"))}),a(".QuotedPrice").keydown(function(b){-1!==a.inArray(b.keyCode,[46,8,9,27,13,110,190])||65==b.keyCode&&(b.ctrlKey===!0||b.metaKey===!0)||b.keyCode>=35&&b.keyCode<=40||(b.shiftKey||b.keyCode<48||b.keyCode>57)&&(b.keyCode<96||b.keyCode>105)&&(a(this).notify("请输入数字",{position:"right",autoHideDelay:1e3,hideDuration:200,className:"error"}),b.preventDefault())});var c=!1;b.TotalVieing=parseInt(a(".TotalViening").last().text()),a(b.QuotedPannel).scroll(function(){if(!c&&a(b.QuotedPannel).scrollTop()>b.QuotedPannel.prop("scrollHeight")-b.QuotedPannel.height()-20&&(c=!0,b.TotalVieing-b.CurrentQuotingLst.length>0)){var d='<li class="loadMore" style="text-align:center;position:absolute;bottom: 21px;width: 93.5%;z-index: 100;background: white;padding: 10px;">信息加载中...</li>';a(d).insertAfter(b.QuotedPannel.find("li").last()),b.QuotPageNo+=1,b.beginQuery(),a(".loadMore").fadeOut(2e3,function(){a(this).addClass("active"),a(this).remove()})}})},beginQuery:function(){var a=this;a.QuotingModel.setterSeries(a.LoginUser.DDUserId,"",a.QuotPageNo,a.QuotPageSize),a.QuotingModel.getRequiringBySeries(function(b){if(1==b.isSuccess){if(b.Data.DATAS.length>0){for(var c=0;c<b.Data.DATAS.length;c++)b.Data.DATAS[c].ImageLst=j(b.Data.DATAS[c].BCREDIT,!0);if(1==a.IsFirstQuery){if(null!=a.CurrentQuotingID)for(var c=0;c<b.Data.DATAS.length;c++)if(b.Data.DATAS[c].REQUIREID==a.CurrentQuotingID){var d=b.Data.DATAS[c];b.Data.DATAS[c]=b.Data.DATAS[0],b.Data.DATAS[0]=d;break}b.Data.DATAS[0].ISACTIVE="active",a.CurrentQuoting=b.Data.DATAS[0]}a.CurrentQuotingLst=a.CurrentQuotingLst.concat(b.Data.DATAS),a.TmplQuoteTemplate.tmpl(b.Data.DATAS).appendTo(".quote-ul")}a.bindEvent()}})},quotingGoods:function(b,c){var d=this,e=d.CurrentLt+","+d.CurrentLg+",["+d.Address.province+","+d.Address.city+","+d.Address.district+",ADDR]",f=c.find(".QuotedNote").val(),g=c.find(".QuotedPrice").val();if(d.showinfo(b)){if(1==isNaN(g)||0==g.length)return void c.find(".QuotedPrice").notify("请输入价格信息和备注再确认发送.",{position:"left"});f==c.find(".QuotedNote").attr("placeholder")&&(f=""),d.QuotGoodsModel.setter(d.LoginUser.DDUserId,d.CurrentQuoting.REQUIREID,"",g,0,f,e),d.QuotGoodsModel.quoteGoods(function(b){1==b.isSuccess&&0==b.Data.STATE&&(h.WriteAnalyze("去报价-报价",{"求购类型":d.CurrentQuoting.SERIES,"报价信息":g}),a(c).notify("报价信息已发送成功！",{position:"left",className:"success",autoHideDelay:1500}),setTimeout(function(){c.parent().slideUp("normal",function(){a(this).remove()}),d.removeGoods()},2500))})}},showinfo:function(b){var c=this,d=!0;return c.navibar.IsValidate?c.navibar.Cert_Pass?c.navibar.Cert_Done?c.navibar.Cert_Doing?d:(a(b).notify("您的资料正在审核中，请耐心等待”->“认证” 去查看,或单击我跳转。",{position:"left",className:"info"}),a(b).parent().find(".notifyjs-container").click(function(){window.open(f.getUrl("Users/ValidateInfo/BaseInfo"),"_blank")}),d=!1):(a(b).notify("您当前未进行认证”->“认证” 去认证,或单击我跳转。",{position:"left",className:"info"}),a(b).parent().find(".notifyjs-container").click(function(){window.open(f.getUrl("Users/ValidateInfo/BaseInfo?type=D"),"_blank")}),d=!1):(a(b).notify("您的资料未通过审核，请到“会员中心”->“认证” 重新认证,或单击我跳转。",{position:"left",className:"info"}),a(b).parent().find(".notifyjs-container").click(function(){window.open(f.getUrl("Users/ValidateInfo/BaseInfo?type=D"),"_blank")}),d=!1):(a(b).notify("手机号未绑定，请到“设置”->“账号绑定处”,或单击我跳转。",{position:"left",className:"info"}),a(b).parent().find(".notifyjs-container").click(function(){window.open(f.getUrl("Users/Setting/BindMobile"),"_blank")}),d=!1)},ingnoreGoods:function(b,c){var d=this;d.showinfo(b)&&(d.IngnoreGoodsModel.setter(d.LoginUser.DDUserId,d.CurrentQuoting.REQUIREID),d.IngnoreGoodsModel.ignoreRequire(function(b){0==b.Data.STATE&&(h.WriteAnalyze("去报价-忽略",{"求购类型":d.CurrentQuoting.SERIES}),a(c).notify("该找货信息已忽略！",{position:"left",className:"info",autoHideDelay:1500}),setTimeout(function(){c.parent().slideUp("normal",function(){a(this).remove()}),d.removeGoods()},2e3))}))},removeGoods:function(){var b=this;-1!=b.CurrentListPosition&&b.CurrentQuotingLst.splice(b.CurrentListPosition,1),b.TotalVieing-=1,a(".TotalViening").text(b.TotalVieing),b.TotalVied=parseInt(a(".TotalVied").last().text()),b.TotalVied+=1,a(".TotalVied").text(b.TotalVied),a(".TotalViening").text(b.TotalVieing),0==b.CurrentQuotingLst.length&&(b.tempPanel.css("display","block"),b.QuotedPannel.css("display","none"))}},o});