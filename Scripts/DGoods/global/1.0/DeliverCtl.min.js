/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerynotify","../utils/SysUrl","jqueryhisotry","NavibarCtl","../utils/Common","../utils/ModelDailog","../utils/SysConfig","../moduler/rs_NewRequire","../viewmodel/NewRequireViewModel","../viewmodel/SmsRulesViewModel","../viewmodel/Require_QuoteViewModel"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(b,c,d){this.GeoLocation=c,this.BoardSpec=a(".board-spec"),this.PipeSpec=a(".pipe-spec"),this.BarSpec=a(".bar-spec"),this.LoginUser=b,this.NewRqModel=new j,this.RuleModel=new k,this.RequireModel=new l,this.newRequirelst=[],this.Address={city:"",province:"",district:""},this.CurrentLt="31.57003745",this.CurrentLg="120.30545590",this.currentRequireId="",this.Ptboardserial="",this.Ptboardserial="",this.Ptpieserial="",this.Ptbarserial="",this.Ptpieserialid="",this.Ptbarserialid="",this.Rules=[],this.navibar=new e(b),void 0!=typeof d&&(this.currentRequireId=d),this.init(),this.queryRules()};return m.prototype={init:function(){var a=this;a.navibar.isIdentify(),a.navibar.buildNavibar(),a.RuleModel.setter(a.LoginUser.DDUserId,"A");new BMap.Geolocation;a.GeoLocation.getCurrentPosition(function(b){this.getStatus()==BMAP_STATUS_SUCCESS&&(a.CurrentLt=b.latitude,a.CurrentLg=b.longitude,a.Address=b.address)},{enableHighAccuracy:!0}),a.newRequirelst=[]},queryRules:function(){function b(){var b=new RegExp(window.SysInfo.SeriesSupport.Board);a(".board-spec>.SERIES").each(function(c,e){for(var c=0;c<d.Rules.length;c++)1==b.test(d.Rules[c].ID)&&a(e).append(a("<option>",{value:d.Rules[c].ID,text:d.Rules[c].NAME}))}),d.boardEvent();for(var e=0;e<d.Rules.length;e++)1==b.test(d.Rules[e].ID)&&(d.Ptboardserial+="<option value='"+d.Rules[e].ID+"'>"+d.Rules[e].NAME+"</option>");var f=new RegExp(window.SysInfo.SeriesSupport.Pipe);a(".pipe-spec>.MATERIAL").each(function(b,e){for(var b=0;b<d.Rules.length;b++)if(1==f.test(d.Rules[b].ID)){d.Ptpieserialid=d.Rules[b].ID,a(".pipe-spec>.SERIES").val(d.Ptpieserialid),c(e,d.Rules[b].MATERIALS);for(var g=0;g<d.Rules[b].MATERIALS.length;g++)d.Ptpieserial+="<option value='"+d.Rules[b].MATERIALS[g].ID+"'>"+d.Rules[b].MATERIALS[g].NAME+"</option>"}});var g=new RegExp(window.SysInfo.SeriesSupport.Bar);a(".bar-spec>.MATERIAL").each(function(b,e){for(var b=0;b<d.Rules.length;b++)if(1==g.test(d.Rules[b].ID)){d.Ptbarserialid=d.Rules[b].ID,a(".bar-spec>.SERIES").val(d.Ptbarserialid),c(e,d.Rules[b].MATERIALS);for(var f=0;f<d.Rules[b].MATERIALS.length;f++)d.Ptbarserial+="<option value='"+d.Rules[b].MATERIALS[f].ID+"'>"+d.Rules[b].MATERIALS[f].NAME+"</option>"}})}function c(b,c){for(var d=0;d<c.length;d++)a(b).append(a("<option>",{value:c[d].ID,text:c[d].NAME}))}var d=this;d.RuleModel.getRules(function(a){1==a.isSuccess&&(d.Rules=a.Data.RULES,b(),""!=d.currentRequireId&&d.setDefault())}),d.bindEvent()},setDefault:function(){var b=this;b.RequireModel.setter(b.LoginUser.DDUserId,b.currentRequireId),b.RequireModel.getRequireDetail(function(c){function d(b,d){a(b).find(".SERIES").val(c.Data.SERIESID).change(),a(b).find(".MATERIAL option").each(function(d,e){a(e).text()==c.Data.MATERIAL&&a(b).find(".MATERIAL").val(a(e).val()).change()}),a(b).find(".SURFACE option").each(function(d,e){a(e).text()==c.Data.SURFACE&&a(b).find(".SURFACE").val(a(e).val()).change()}),a(b).find(".DELIVERY").val(c.Data.DELIVERY),a(b).find(".DETAIL").val(c.Data.DETAIL),a(b).find(".EXTRA").val(c.Data.SURFACE)}function e(b){a(".tab-find-ul").find("li").removeClass("active"),a(b).addClass("active")}if(0==c.Data.STATE){var f=new RegExp(window.SysInfo.SeriesSupport.Board),g=new RegExp(window.SysInfo.SeriesSupport.Pipe),h=new RegExp(window.SysInfo.SeriesSupport.Bar);f.test(c.Data.SERIESID)?(b.boardEvent(),d(a(".board-spec"),c.Data),e(a("#find-board")),a("#board-form").show(),a("#pipe-form").hide(),a("#bar-form").hide()):g.test(c.Data.SERIESID)?(d(a(".pipe-spec"),c.Data),e(a("#find-pipe")),a("#board-form").hide(),a("#pipe-form").show(),a("#bar-form").hide()):h.test(c.Data.SERIESID)&&(d(a(".bar-spec"),c.Data),e(a("#find-bar")),a("#board-form").hide(),a("#pipe-form").hide(),a("#bar-form").show())}})},boardEvent:function(){function b(a,b){return a.NAME>b.NAME?1:a.NAME<b.NAME?-1:0}var c=this;f.PlaceHolder(),a(".board-spec>.SERIES").change(function(){var d=a(this).val();a(this).parent().find(".MATERIAL").empty(),a(this).parent().find(".MATERIAL").append('<option value="">材质</option>'),a(this).parent().find(".SURFACE").empty(),a(this).parent().find(".SURFACE").append('<option value="">表面</option>');for(var e=0;e<c.Rules.length;e++)if(c.Rules[e].ID==d){for(var f=0;f<c.Rules[e].MATERIALS.length;f++)a(this).parent().find(".MATERIAL").append(a("<option>",{value:c.Rules[e].MATERIALS[f].ID,text:c.Rules[e].MATERIALS[f].NAME}));c.Rules[e].SURFACES.sort(b);for(var g=0;g<c.Rules[e].SURFACES.length;g++)a(this).parent().find(".SURFACE").append(a("<option>",{value:c.Rules[e].SURFACES[g].ID,text:c.Rules[e].SURFACES[g].NAME}))}})},bindEvent:function(){function b(b){a(".tab-find-ul").find("li").removeClass("active"),a(b).addClass("active")}function d(b){var c=null,d=a(b).closest("form").find(".find-num").first();return a(d).find(".DELIVERY").val().length>0?c=d.find(".DELIVERY").val():""!=e.Address.city&&(c=e.Address.city),c}var e=this;a(".btn-newrequire").click(function(b){return e.navibar.IsValidate?e.navibar.Cert_Pass?e.navibar.Cert_Done?e.navibar.Cert_Doing?void e.sendRequire(this):(a(this).notify("您的资料正在审核中，请耐心等待”->“认证” 去查看,或单击我跳转。",{position:"bottom",className:"info"}),a(this).parent().find(".notifyjs-container").click(function(){window.open(c.getUrl("Users/ValidateInfo/BaseInfo?type=D"),"_blank")}),void b.preventDefault()):(a(this).notify("您当前未进行认证”->“认证” 去认证,或单击我跳转。",{position:"bottom",className:"info"}),a(this).parent().find(".notifyjs-container").click(function(){window.open(c.getUrl("Users/ValidateInfo/BaseInfo?type=D"),"_blank")}),void b.preventDefault()):(a(this).notify("您的资料未通过审核，请到“会员中心”->“认证” 重新认证,或单击我跳转。",{position:"bottom",className:"info"}),a(this).parent().find(".notifyjs-container").click(function(){window.open(c.getUrl("Users/ValidateInfo/BaseInfo?type=D"),"_blank")}),void b.preventDefault()):(a(this).notify("手机号未绑定，请到“设置”->“账号绑定处”,或单击我跳转。",{position:"bottom",className:"info"}),a(this).parent().find(".notifyjs-container").click(function(){window.open(c.getUrl("Users/Setting/BindMobile"),"_blank")}),void b.preventDefault())}),a(".findD-main").unbind("click"),a(".findD-main").click(function(a){a.preventDefault(),a.stopPropagation()}),a("#find-board").click(function(){var c=a(this);return a("#board-form").show(),a("#pipe-form").hide(),a("#bar-form").hide(),b(c),!1}),a("#find-pipe").click(function(){var c=a(this);return a("#board-form").hide(),a("#pipe-form").show(),a("#bar-form").hide(),b(c),!1}),a("#find-bar").click(function(){var c=a(this);return a("#board-form").hide(),a("#pipe-form").hide(),a("#bar-form").show(),b(c),!1}),a(".btn-board").unbind("click"),a(".btn-board").click(function(){var a=d(this);e.addboardSpec(a),e.showDel()}),a(".btn-pipe").unbind("click"),a(".btn-pipe").click(function(){var a=d(this);e.addpipeSpec(a),e.showDel()}),a(".btn-bar").unbind("click"),a(".btn-bar").click(function(){var a=d(this);e.addbarSpec(a),e.showDel()})},validedModel:function(b){var c=this,d=a(b).closest("form"),e=a.extend({},i.Req),f=3e3,g=200,h=a(b).find(".SERIES"),j=a(b).find(".MATERIAL"),k=a(b).find(".DELIVERY"),l=a(b).find(".SURFACE"),m=a(b).find(".EXTRA"),n=a(b).find(".DETAIL");e.USERID=c.LoginUser.DDUserId,e.SERIES=h.val(),e.MATERIAL=j.val(),e.SURFACE=l.val(),e.EXPIRES=0,e.EXTRA=m.val()==m.attr("placeholder")?"":m.val(),e.DETAIL=n.val()==n.attr("placeholder")?"":n.val(),e.LOCATION=c.CurrentLt+","+c.CurrentLg+",["+c.Address.province+","+c.Address.city+","+c.Address.district+",ADDR]",e.DELIVERY=k.val()==k.attr("placeholder")?"":k.val();var o=!0;return""!=e.DELIVERY&&""!=e.MATERIAL&&""!=e.DETAIL||(""==e.DELIVERY&&"block"==a(d).css("display")&&k.notify("填写交货地址.",{position:"right",autoHideDelay:f,hideDuration:g}),""==e.MATERIAL&&"block"==a(d).css("display")&&j.notify("请选择材质/种类.",{position:"bottom",autoHideDelay:f,hideDuration:g}),""==e.DETAIL&&"block"==a(d).css("display")&&n.notify("请注明求购明细.",{position:"right",autoHideDelay:f,hideDuration:g}),o=!1),"board-form"==a(d).attr("id")&&(""==e.SERIES&&(o=!1,"block"==a(d).css("display")&&h.notify("请选择系列.",{position:"bottom",autoHideDelay:f,hideDuration:g})),""==e.SURFACE&&(o=!1,"block"==a(d).css("display")&&l.notify("请选择表面",{position:"right",autoHideDelay:f,hideDuration:g}))),"pipe-form"==a(d).attr("id")&&""==e.EXTRA&&(o=!1,"block"==a(d).css("display")&&m.notify("请填写材质要求",{position:"right",autoHideDelay:f,hideDuration:g})),"bar-form"==a(d).attr("id")&&""==e.EXTRA&&("block"==a(d).css("display")&&m.notify("请填写材质要求",{position:"right",autoHideDelay:f,hideDuration:g}),o=!1),o?e:null},addboardSpec:function(b){var c=this,d='<p class="find-num board-spec"><select class="SERIES"><option value="">请选择系列</option>'+c.Ptboardserial+'</select><select class="MATERIAL"><option value="">材质</option></select><select class="SURFACE"><option value="">表面</option>';d+=null==b?'</select><input class="DELIVERY find-delivery" maxlength="8" type="text" placeholder="交货地，如无锡"   />':'</select><input class="DELIVERY find-delivery" maxlength="8" type="text" placeholder="交货地，如无锡" value='+b+" />",d+='<input class="DETAIL find-note" type="text" placeholder="请输入求购明细，按顺序如“5.0*1500*C/20吨/太钢”" /> <i class="iconfont icon-roundclose btn-del"></i></p>',a(d).insertAfter(a(".board-spec").last()),c.boardEvent()},addpipeSpec:function(b){var c=this,d='<p class="find-num pipe-spec"><input type="hidden" class="SERIES" value="'+c.Ptpieserialid+'" /> <select class="MATERIAL"><option value="">请选择种类</option>'+c.Ptpieserial+'</select><input class="EXTRA find-requi" type="text" placeholder="材质要求"   />';d+=null==b?'<input class="DELIVERY find-delivery" maxlength="8"  type="text" placeholder="交货地，如无锡"   />':'<input class="DELIVERY find-delivery" maxlength="8" type="text" placeholder="交货地，如无锡" value='+b+" />",d+=' <input class="DETAIL find-bang" type="text" placeholder="请输入求购明细，如“20*2.0/青山”" /><i class="iconfont icon-roundclose btn-del"></i></p>',a(d).insertAfter(a(".pipe-spec").last())},addbarSpec:function(b){var c=this,d='<p class="find-num bar-spec"><input type="hidden" class="SERIES" value="'+c.Ptbarserialid+'" /> <select class="MATERIAL">'+c.Ptbarserial+'</select><input class="EXTRA find-requi" type="text" placeholder="材质要求"   />';d+=null==b?'<input class="DELIVERY find-delivery" maxlength="8" type="text" placeholder="交货地，如无锡"   />':'<input class="DELIVERY find-delivery" maxlength="8" type="text" placeholder="交货地，如无锡" value='+b+" />",d+='<input class="DETAIL find-bang" type="text" placeholder="请输入求购明细，如“Φ22/青山”" /><i class="iconfont icon-roundclose btn-del" ></i></p>',a(d).insertAfter(a(".bar-spec").last())},showDel:function(){function b(){a("#board-form .btn-del").css("display","none"),a("#board-form .btn-del").length>1&&a("#board-form .btn-del").css("display","block"),a("#pipe-form .btn-del").css("display","none"),a("#pipe-form .btn-del").length>1&&a("#pipe-form .btn-del").css("display","block"),a("#bar-form .btn-del").css("display","none"),a("#bar-form .btn-del").length>1&&a("#bar-form .btn-del").css("display","block")}b(),a(".btn-del").click(function(c){a(this).closest("p").remove(),b()})},sendRequire:function(b){function d(a){var b=e.validedModel(a);null!=b?e.newRequirelst.push(b):g=!1}var e=this,g=!0;e.newRequirelst=[];var h,i="",j=a(b).closest("form").attr("id");if("board-form"==j&&(i="板材",h=a(".board-spec"),a(".board-spec").each(function(a,b){d(b)})),"pipe-form"==j&&(i="管材",h=a(".pipe-spec"),a(".pipe-spec").each(function(a,b){d(b)})),"bar-form"==j&&(i="棒材",h=a(".bar-spec"),a(".bar-spec").each(function(a,b){d(b)})),0!=e.newRequirelst.length&&g){var k=0,l=[];a(document).scrollTop();e.NewRqModel.setterlst(e.newRequirelst),e.NewRqModel.newRequirelst(function(a){if(k+=1,0==a.Data.STATE&&l.push(a.Data.REQUIREID),k==e.newRequirelst.length)if(f.WriteAnalyze("买家求购",{"求购类型":i,"求购数量":k}),l.length==k){var b={title:"求购信息发送成功",desc:"本次共提交"+l.length.toString()+"求购信息。",button:{cleanBtn:{visable:!0,text:"返回",OnCancel:function(){e.resetDeliver(h)}},enterBtn:{text:"查看找货单",url:"",onConfrim:function(){window.open(c.getUrl("/DGoods/Deliver/Finding"),"_self")}},extendBtn:{visable:!0,text:"推荐找货",url:"",OnExtendClick:function(){f.WriteAnalyze("推荐找货",{"求购类型":i,"求购数量":k}),e.postToRmd(l)}}}},d=new f.CustDialog(b);d.showNoCertDialog()}else{var b={title:"求购信息发送成功",desc:"本次共提交"+l.length.toString()+"求购信息。 失败"+(k-l.length)+"条找货信息。",button:{cleanBtn:{visable:!0,text:"返回",OnCancel:function(){e.resetDeliver(h)}},enterBtn:{text:"查看找货单",url:"",onConfrim:function(){window.open(c.getUrl("/DGoods/Deliver/Finding"),"_self")}},extendBtn:{visable:!0,text:"推荐找货",url:"",OnExtendClick:function(){e.postToRmd(l)}}}},d=new f.CustDialog(b);d.showNoCertDialog()}})}},resetDeliver:function(b){a(b).each(function(b,c){b>=1&&a(c).remove(),a(c).find(".SERIES").val(""),a(c).find(".MATERIAL").val(""),a(c).find(".SURFACE").val(""),a(c).find(".DELIVERY").val(""),a(c).find(".DETAIL").val(""),a(c).find(".EXTRA").val("")})},postToRmd:function(a){var b=document.createElement("form");b.action=c.getUrl("/DGoods/VieOrder/RmdOrder"),b.method="post",b.target="_self";for(var d=0;d<a.length;d++){var e=document.createElement("textarea");e.id="requireid["+d.toString()+"]",e.name="requireid["+d.toString()+"]",e.value=a[d],b.appendChild(e)}b.style.display="none",document.body.appendChild(b),b.submit()}},m});