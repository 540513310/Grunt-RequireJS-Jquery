/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerynotify","jquerytmpl","NavibarCtl","../utils/SysUrl","../utils/Common","../utils/ConsumeLevel","../utils/SysConfig","../viewmodel/GoodsDealViewModel","../viewmodel/Require_QuoteViewModel","../viewmodel/CommentDealViewModel","../viewmodel/ContractInfoViewModel"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(b){this.tempPanel=a(".findD-none"),this.LeftPanel=a(".vien-left"),this.RightPanel=a(".vien-right"),this.lbDealtCount=a(".TotalDealt"),this.lbStartTime=a(".LbStartTime"),this.lbSeries=a(".LbSeries"),this.lbDetail=a(".LbDetail"),this.lbScompany=a(".LbSCompany"),this.lbSContact=a(".LbSContact"),this.lbSUserTel=a(".LbSUserTel"),this.lbDealtPrice=a(".LbDealtPrice"),this.lbDescription=a(".LbDescription"),this.lbOfferCount=a(".LbOfferCount"),this.lbSOfferCount=a(".LbSOFFERCOUNT"),this.lbStartTime=a(".LbStartTime"),this.btnComment=a(".btn-Comment"),this.TotalDealt=0,this.TmplRequireMarkUp=a("#DealtTemplate"),this.SalesLevelMarkUp=a("#SalesLevelTemplate"),this.RequireMarkUp=a(".DealtMarkUp"),this.Saleslevel=a(".Saleslevel"),this.LoginUser=b,this.FindModel=new i,this.RequirePageNo=window.SysInfo.Paging.VisiblePages,this.RequirePageSize=window.SysInfo.Paging.DftPageSize,this.RequireDetailModel=new j,this.CurrentRequireID=null,this.CurrentOfferID=null,this.CommentModel=new k,this.ContractModel=new l,this.CurrentRequireLst=[],this.CurrentRequire={},this.IsFirstQuery=!0,this.navibar=new d(b),this.init()};return m.prototype={init:function(){var b=this;b.CurrentRequireLst=[],b.LeftPanel.hide(),b.RightPanel.hide(),b.navibar.buildNavibar(function(c){c.CONFIRMED>0&&0==c.STATE&&b.beginQueryDealt(),0==c.CONFIRMED||0!=c.STATE?b.tempPanel.css("display","block"):(b.LeftPanel.css("display","block"),b.RightPanel.css("display","block")),b.navibar.buildScroll(),a(".TotalDealt").first().closest("dd").addClass("active")})},setCurrent:function(){var a=this;a.lbDescription.text(a.CurrentRequire.NOTE),a.lbSeries.text(a.CurrentRequire.SERIES+"/"+a.CurrentRequire.MATERIAL+"/"+a.CurrentRequire.SURFACE),a.lbDetail.text(a.CurrentRequire.DETAIL+"   交货地点:"+a.CurrentRequire.DELIVERY),a.lbScompany.text(),a.lbSContact.text(),a.lbSUserTel.text(),"Y"==a.CurrentRequire.BCOMMENTED?a.btnComment.css("display","none"):a.btnComment.css("display","block"),a.bindRightEvents()},beginQueryDetail:function(){function a(){b.lbOfferCount.text(b.CurrentRequire.Contract.OFFERS),b.lbDealtPrice.text(b.CurrentRequire.Contract.DEALPRICE),b.lbSOfferCount.text(b.CurrentRequire.Contract.SOFFERCOUNT),b.lbScompany.text(b.CurrentRequire.Contract.SCOMPANY),b.lbSContact.text(b.CurrentRequire.Contract.SCONTACT),b.lbSUserTel.text(b.CurrentRequire.Contract.STEL);var a={ImageLst:g(b.CurrentRequire.Contract.SCREDIT,!1)};b.Saleslevel.empty(),b.SalesLevelMarkUp.tmpl(a).appendTo(".Saleslevel")}var b=this;void 0==b.CurrentRequire.Contract?(b.ContractModel.setter(b.LoginUser.DDUserId,b.CurrentRequire.CONTRACTID),b.ContractModel.getContractInfo(function(c){c.isSuccess&&(b.CurrentRequire.Contract=c.Data,a())})):a(),void 0==b.CurrentRequire.RequireDetail?(b.RequireDetailModel.setter(b.LoginUser.DDUserId,b.CurrentRequire.REQUIREID),b.RequireDetailModel.getRequireDetail(function(a){a.isSuccess&&(b.CurrentRequire.RequireDetail=a.Data,b.lbStartTime.text(b.CurrentRequire.RequireDetail.PUBDATE))})):b.lbStartTime.text(b.CurrentRequire.RequireDetail.PUBDATE)},beginQueryDealt:function(){var a=this;a.FindModel.setter(a.LoginUser.DDUserId,"B",a.RequirePageNo,a.RequirePageSize),a.FindModel.quoteGoods(function(b){1==b.isSuccess&&b.Data.DATAS.length>0&&(1==a.IsFirstQuery&&(a.IsFirstQuery=!1,b.Data.DATAS[0].ISACTIVE="active",a.CurrentRequire=b.Data.DATAS[0],a.CurrentRequireID=b.Data.DATAS[0].REQUIREID,a.beginQueryDetail()),a.CurrentRequireLst=a.CurrentRequireLst.concat(b.Data.DATAS),a.TmplRequireMarkUp.tmpl(b.Data.DATAS).appendTo(".vien-left"),a.bindLeftEvents(),a.setCurrent())})},bindLeftEvents:function(){var b=this;b.LeftPanel.find("li").unbind("click"),b.LeftPanel.find("li").click(function(){b.LeftPanel.find("li").removeClass("active"),a(this).addClass("active"),b.CurrentRequire=null,b.CurrentRequireID=a(this).attr("data-id");for(var c=0;c<b.CurrentRequireLst.length;c++)if(b.CurrentRequireLst[c].REQUIREID==b.CurrentRequireID){b.CurrentRequire=b.CurrentRequireLst[c],b.setCurrent();break}null!=b.CurrentRequire&&b.beginQueryDetail()});var c=!1;b.TotalDealt=parseInt(a(".TotalDealt").last().text()),a(b.LeftPanel).scroll(function(){if(!c&&a(b.LeftPanel).scrollTop()>b.LeftPanel.prop("scrollHeight")-b.LeftPanel.height()-20&&(c=!0,b.TotalDealt-b.CurrentRequireLst.length>0)){var d='<li class="loadMore" style="text-align:center;position:absolute;bottom: 21px;width: 54.4%;z-index: 100;background: white;">信息加载中...</li>';a(d).insertAfter(b.LeftPanel.find("li").last()),b.RequirePageNo+=1,b.beginQueryDealt(),a(".loadMore").fadeOut(2e3,function(){a(this).addClass("active"),a(this).remove()})}})},bindRightEvents:function(){var b=this;a(".btn-Comment").unbind("click"),a(".btn-Comment").on("click",function(c){a(this).closest("li"),a(".DealtMarkUp.active");b.showdialog()})},showdialog:function(){var b=this;b.CurrentRequire.CommentScore=5;for(var c="",d=1;6>d;d++)c+='<div class="imag-comment '+d+'" data-score="'+d+'" ></div>';var e={title:"DD找货 评价卖家",desc:'<div class="dialog-comment"><span class="desc-comment">综合评分：</span>'+c+"</div>",htmlTemplate:'<div class="msg body"><div class="msg body-note"> <textarea placeholder="输入对卖家的评价" class="LbNote" maxlength=300 rows=6 cols=60   ></textarea><span class="ex-word">最多只能输入300字</span></div><div class="msg body-states"><span class="txtStates">0/300</span></div>',button:{cleanBtn:{visable:!0,text:"取消",OnCancel:function(){}},enterBtn:{text:"提交",onConfrim:function(){b.CommentModel.setter(b.LoginUser.DDUserId,b.CurrentRequire.CONTRACTID,b.CurrentRequire.CommentScore,b.CurrentRequire.CommentTxt,"B"),b.CommentModel.sendcomment(function(c){0==c.Data.STATE?(f.WriteAnalyze("已确认-评价",{"求购类型":b.CurrentRequire.SERIES,"成交价格":b.CurrentRequire.DEALPRICE}),b.CurrentRequire.BCOMMENTED="Y",a(".LbSContact").notify("对卖家评价成功,积分+"+c.Data.SCORE,{position:"bottom",className:"success"}),b.btnComment.css("display","none")):alert(c.Data.MSG)})}}}},g=new f.CustDialog(e);g.showNoCertDialog(),f.PlaceHolder(),b.eventMonitor()},eventMonitor:function(){function b(){var b=a(".LbNote").val();b.length>=300&&(a(".ex-word").show(),a(".LbNote").css("border","1px solid red"),a(".body-states").css("border","1px solid red"),a(".body-states").css("border-top","none"),a(".LbNote").val(a(".LbNote").val().substring(0,300))),b.length<300&&(a(".ex-word").hide(),a(".LbNote").css("border","1px solid #a9a9a9"),a(".body-states").css("border","1px solid #a9a9a9"),a(".body-states").css("border-top","none"))}var c=this;a(".dialog-comment").unbind("click"),a(".dialog-comment>.imag-comment").click(function(){a(".dialog-comment>.imag-comment").each(function(b,c){a(c).css("background-image","url(/Content/Users/DGoods/Images/star-gray.png)")});for(var b=parseInt(a(this).attr("data-score")),d=a(this).parent(),e=1;b+1>e;e++)d.find(".imag-comment."+e.toString()).css("background-image","url(/Content/Users/DGoods/Images/star_yellow.png)");c.CurrentRequire.CommentScore=b}),a(".LbNote").unbind("keyup"),a(".LbNote").keyup(function(){if(b(),a(this).val()>300)return!1;c.CurrentRequire.CommentTxt=a(this).val();var d=c.CurrentRequire.CommentTxt.toString().length;a(".txtStates").text(d.toString()+"/300")})}},m});