/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerytmpl","jqueryhisotry","NavibarCtl","../utils/SysUrl","../utils/ConsumeLevel","../utils/SysConfig","../utils/Common","../moduler/rs_Required_Quoted","../viewmodel/ReqMyGdViewModel","../viewmodel/Dis_DelRequireViewModel","../viewmodel/Require_QuoteViewModel","../viewmodel/CfmQuoteViewModel"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=function(b,c){this.tempPanel=a(".findD-none"),this.LeftPanel=a(".vien-left"),this.RightPanel=a(".vien-right"),this.tempDiv='<div class="findD-none">您没有抢过的单子哦</div>',this.lbOfferCount=a(".LbOfferCount"),this.lbfindingCount=a(".TotalFinding"),this.lbEndTime=a(".LbEndTime"),this.lbSeries=a(".LbSeries"),this.lbDetail=a(".LbDetail"),this.TotalFinding=0,this.TmplRequireMarkUp=a("#RequireTemplate"),this.RequireMarkUp=a(".RequireMarkUp"),this.QuoteModel=new l,this.QuotePageNo=window.SysInfo.Paging.VisiblePages,this.QuotePageSize=100,this.TmplVieMarkUp=a("#QuotedTemplate"),this.QuotedMarkUp=a(".QuotedMarkUp"),this.ConfirmQuotedBtn=a(".menu_btn.menu_btn_sub.btn-intention"),this.LoginUser=b,this.FindModel=new j,this.RequirePageNo=window.SysInfo.Paging.VisiblePages,this.RequirePageSize=window.SysInfo.Paging.DftPageSize,this.CurrentRequireID=null,this.CurrentOfferID=null,this.ConfirmModel=new m,this.DimissModel=new k,this.CurrentRequireLst=[],this.CurrentRequire={},this.IsFirstQuery=!0,this.navibar=new d(b),this.init(),"undefined"!=typeof c&&c.length>0&&(this.CurrentRequireID=c)};return n.prototype={init:function(){var b=this;"object"==typeof b.LoginUser&&void 0!=b.LoginUser||(window.location=e.getUrl("/Account/Login?ReturnUrl="+window.location.pathname)),b.navibar.buildNavibar(function(c){c.OFFERING>0&&0==c.STATE&&b.beginQueryFinding(),0==c.OFFERING||0!=c.STATE?b.tempPanel.css("display","block"):(b.LeftPanel.css("display","block"),b.RightPanel.css("display","block")),b.navibar.buildScroll(),a(".TotalFinding").first().closest("dd").addClass("active")}),History.pushState("","求购 - 找货中-东方商城","/DGoods/Deliver/Finding"),b.LeftPanel.empty(),b.CurrentRequireLst=[]},setCurrent:function(){var a=this;a.lbOfferCount.text(a.CurrentRequire.OFFERCOUNT),a.lbEndTime.text(a.CurrentRequire.ENDTIME+"到期"),a.lbSeries.text(a.CurrentRequire.SERIES+"/"+a.CurrentRequire.MATERIAL+"/"+a.CurrentRequire.SURFACE),a.lbDetail.text(a.CurrentRequire.DETAIL+"     交货地点:"+a.CurrentRequire.DELIVERY)},beginQueryFinding:function(){var a=this;a.FindModel.setter(a.LoginUser.DDUserId,"A","B",a.RequirePageNo,a.RequirePageSize),a.FindModel.getMyGoods(function(b){if(1==b.isSuccess&&b.Data.DATAS.length>0){if(1==a.IsFirstQuery){if(a.IsFirstQuery=!1,null!=a.CurrentRequireID)for(var c=0;c<b.Data.DATAS.length;c++)if(b.Data.DATAS[c].REQUIREID==a.CurrentRequireID){var d=b.Data.DATAS[c];b.Data.DATAS[c]=b.Data.DATAS[0],b.Data.DATAS[0]=d;break}b.Data.DATAS[0].ISACTIVE="active",a.CurrentRequire=b.Data.DATAS[0],a.CurrentRequireID=b.Data.DATAS[0].REQUIREID,a.queryQuoted()}a.CurrentRequireLst=a.CurrentRequireLst.concat(b.Data.DATAS),a.TmplRequireMarkUp.tmpl(b.Data.DATAS).appendTo(".vien-left"),a.bindLeftEvents(),a.setCurrent()}})},queryQuoted:function(){var b=this;b.QuoteModel.setter(b.LoginUser.DDUserId,b.CurrentRequireID,b.QuotedPageNo,b.QuotePageSize),b.QuoteModel.getQuoted(function(c){if(1==c.isSuccess){for(var d=0;d<c.Data.DATAS.length;d++)c.Data.DATAS[d].ImageLst=f(c.Data.DATAS[d].SCREDIT,!1);a(".vien-right-ul").empty(),b.TmplVieMarkUp.tmpl(c.Data.DATAS).appendTo(".vien-right-ul"),b.bindRightEvents()}else alert(c.ErrorMsg)})},DimissGoods:function(b){var c=this,d=(a(b).closest(".vien-right"),a(".RequireMarkUp.active"));c.DimissModel.setter(c.LoginUser.DDUserId,c.CurrentRequire.REQUIREID),c.DimissModel.dimissRequire(function(b){if(0==b.Data.STATE){c.CurrentRequire=i.RepRequireWithQuoting,h.WriteAnalyze("找货中页-撤单成功",{"求购类型":c.CurrentRequire.SERIES});for(var e=0,f=0;f<c.CurrentRequireLst.length-1;f++)if(c.CurrentRequireLst[f].REQUIREID==c.CurrentRequireID){c.CurrentRequire=c.CurrentRequireLst[f+1],c.CurrentRequireLst.splice(f,1),e=f;break}0==e&&c.CurrentRequireLst.length>0&&(c.CurrentRequire=c.CurrentRequireLst[0]),a(".RequireMarkUp[data-id='"+c.CurrentRequire.REQUIREID+"']").addClass("active"),c.setCurrent(),d.slideUp("normal",function(){a(this).remove()})}})},Recommand:function(){h.WriteAnalyze("找货中页-推荐",{"求购类型":this.CurrentRequire.SERIES}),window.open(e.getUrl("/DGoods/VieOrder/RmdOrder?requireid="+this.CurrentRequire.REQUIREID),"_blank")},bindLeftEvents:function(){var b=this;a(".btn-Dimiss").unbind("click"),a(".btn-Dimiss").click(function(a){h.WriteAnalyze("找货中页-撤单",{"求购类型":b.CurrentRequire.SERIES});var c=this,d={title:"DD找货提示",desc:"您确认撤销当前的找货消息吗？",button:{cleanBtn:{visable:!0,text:"取消"},enterBtn:{text:"确认",url:"",onConfrim:function(){b.DimissGoods(c),b.removeItem()}}}},e=new h.CustDialog(d);e.showNoCertDialog()}),a(".btn-Recommand").unbind("click"),a(".btn-Recommand").click(function(){b.Recommand(this)}),b.LeftPanel.find("li").unbind("click"),b.LeftPanel.find("li").click(function(){b.LeftPanel.find("li").removeClass("active"),a(this).addClass("active"),b.CurrentRequireID=a(this).attr("data-id");for(var c=0;c<b.CurrentRequireLst.length;c++)if(b.CurrentRequireLst[c].REQUIREID==b.CurrentRequireID){b.CurrentRequire=b.CurrentRequireLst[c],b.setCurrent();break}b.queryQuoted()});var c=!1;b.TotalFinding=parseInt(a(".TotalFinding").last().text()),a(b.LeftPanel).scroll(function(){if(!c&&a(b.LeftPanel).scrollTop()>b.LeftPanel.prop("scrollHeight")-b.LeftPanel.height()-20&&(c=!0,b.TotalFinding-b.CurrentRequireLst.length>0)){var d='<li class="loadMore" style="text-align:center;position:absolute;bottom: 21px;width: 54.4%;z-index: 100;background: white;">信息加载中...</li>';a(d).insertAfter(b.LeftPanel.find("li").last()),b.RequirePageNo+=1,b.beginQueryFinding(),a(".loadMore").fadeOut(2e3,function(){a(this).addClass("active"),a(this).remove()})}})},bindRightEvents:function(){var b=this;b.ConfirmQuotedBtn=a(".comfirm-deal"),b.ConfirmQuotedBtn.unbind("click"),b.ConfirmQuotedBtn.on("click",function(c){var d=this,f={title:"DD找货提示",desc:"确认当前的报价意向吗？",button:{cleanBtn:{visable:!0,text:"取消"},enterBtn:{text:"确认",url:"",onConfrim:function(){var c=a(d).closest("li");a(".RequireMarkUp.active");b.CurrentOfferID=c.attr("data-id"),b.ConfirmModel.setter(b.LoginUser.DDUserId,b.CurrentRequireID,b.CurrentOfferID),b.ConfirmModel.confirmQuoted(function(a){0==a.Data.STATE&&(h.WriteAnalyze("找货中页-确认意向",{"求购类型":b.CurrentRequire.lbSeries}),window.open(e.getUrl("DGoods/Deliver/Dealt"),"_self"))})}}}},g=new h.CustDialog(f);g.showNoCertDialog()})},removeItem:function(){var b=this,c=parseInt(b.lbfindingCount.first().text()),d=parseInt(a(".TotalDealt").first().text());c-=1,d+=1,a(".TotalDealt").text(d),b.lbfindingCount.text(c),0==c&&(b.tempPanel.css("display","block"),b.LeftPanel.css("display","none"),b.RightPanel.css("display","none"))}},n});