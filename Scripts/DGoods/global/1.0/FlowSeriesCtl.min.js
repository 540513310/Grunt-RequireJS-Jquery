/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerytmpl","jquerynotify","NavibarCtl","../utils/CreateObject","../utils/SysUrl","../viewmodel/SmsRulesViewModel","../viewmodel/RulesInfoViewModel","../moduler/rs_SmsCode_Rules"],function(a,b,c,d,e,f,g,h,i){function j(a){this.LoginUser=a,this.RulesViewModel=new g,this.RuleInfoVModel=new h,this.CurrentSelectStr={},this.CurrentSelectRules=[],this.CurrentTotollyRules=[],this.SeriesTemplate=$("#SeriesTemplate"),this.AfterSeriesTemplate=$("#AfterSeriesTemplate"),this.LbRmdBefore="#rmd-before",this.LbRmdAfter="#rmd-after",this.navibar=new d(this.LoginUser),this.IsChanged=!1,this.init(),this.querySeries()}return j.prototype={init:function(){var a=this;a.navibar.buildNavibar(),$(".FollowSeries").first().closest("dd").addClass("active")},querySeries:function(){var a=this;a.RulesViewModel.setter(a.LoginUser.DDUserId,"A"),a.RulesViewModel.getRules(function(b){1==b.isSuccess&&(a.CurrentTotollyRules={SERIES:b.Data.RULES},a.CurrentSelectStr={SERIES:b.Data.SERIES.split(","),MATERIAL:b.Data.MATERIAL.split(","),SURFACE:b.Data.SURFACE.split(",")},a.setDefaultRules(),a.SeriesTemplate.tmpl(a.CurrentSelectRules).appendTo(a.LbRmdBefore),a.AfterSeriesTemplate.tmpl(a.CurrentTotollyRules).appendTo(a.LbRmdAfter)),a.bindEvent()})},setDefaultRules:function(){function a(a,b){for(var c=[],d=0;d<a.length;d++)for(var e=0;e<b.MATERIALS.length;e++)if(b.MATERIALS[e].ID==a[d]){b.MATERIALS[e].IsActive="active";var f=$.extend({},i.RspRulesDetail);f=b.MATERIALS[e],c.push(f)}return c}function b(a,b){for(var c=[],d=0;d<a.length;d++)for(var e=0;e<b.SURFACES.length;e++)if(b.SURFACES[e].ID==a[d]){b.SURFACES[e].IsActive="active";var f=$.extend({},i.RspRulesDetail);f=b.SURFACES[e],c.push(f)}return c}for(var c=this,d=[],e=0;e<c.CurrentSelectStr.SERIES.length;e++)for(var f=0;f<c.CurrentTotollyRules.SERIES.length;f++)if(c.CurrentTotollyRules.SERIES[f].ID==c.CurrentSelectStr.SERIES[e]){c.CurrentTotollyRules.SERIES[f].IsActive="active";var g=$.extend({},c.CurrentTotollyRules.SERIES[f]);g.MATERIALS=a(c.CurrentSelectStr.MATERIAL,c.CurrentTotollyRules.SERIES[f]),g.SURFACES=b(c.CurrentSelectStr.SURFACE,c.CurrentTotollyRules.SERIES[f]),d.push(g)}c.CurrentSelectRules={SERIES:d}},bindEvent:function(){var a=this;a.checkStates(),$(".btn-modify").css("display","block"),$(".btn-modify").click(function(){$(".btn-modify").hide(),$("#rmd-before").hide(),$(".btn-deter").show(),$("#rmd-after").show()}),$(".btn-deter").click(function(){a.getRuleSeries(),a.saveRules(),void 0!=$(".btn-modify")[0]&&a.CurrentSelectRules.SERIES.length>0&&($(".btn-modify").show(),$("#rmd-before").show(),$(".btn-deter").hide(),$("#rmd-after").hide()),a.IsChanged=!1}),$(".btn-nav").unbind("click"),$(".btn-nav").click(function(){window.open(f.getUrl("DGoods/VieOrder/Quoted"),"_self")}),$(".btn-add-fol").click(function(){a.IsChanged=!0;var b=$(this).closest(".rmd-list").hasClass("active");b?($(this).val("取消关注"),$(this).closest(".rmd-list").removeClass("active"),a.setStates($(this).closest(".rmd-list").find(".rmd-list-right"),!0)):($(this).val("+关注"),$(this).closest(".rmd-list").addClass("active"),a.setStates($(this).closest(".rmd-list").find(".rmd-list-right"),!1))}),$("#rmd-after .rmd-list-right li").click(function(){var b=$(this).hasClass("active");a.IsChanged=!0,1==b?$(this).removeClass("active"):$(this).addClass("active"),a.checkStates()}),0==a.CurrentSelectRules.SERIES.length&&($(".btn-modify").hide(),$("#rmd-before").hide(),$(".btn-deter").show(),$("#rmd-after").show())},setStates:function(a,b){var c=!1,d=$(a).find("ul"),c=!1;return d.each(function(a,c){b?$(c).find("li").addClass(" active"):$(c).find("li").removeClass(" active")}),c},getStates:function(a){var b=!1,c=$(a).find("ul"),b=!1;return c.each(function(a,c){$(c).find("li").hasClass("active")&&(b=!0)}),b},checkStates:function(){var a=this;$("#rmd-after .rmd-list").each(function(b,c){var d=a.getStates(c);1==d?($(c).find(".btn-follow").val("取消关注"),$(this).closest(".rmd-list").removeClass("active")):($(c).find(".btn-follow").val("+关注"),$(this).closest(".rmd-list").addClass("active"))})},getRuleSeries:function(){for(var a=this,b=[],c=[],d=[],e=$("#rmd-after .rmd-list-right li[class$='active']"),f=$(e).closest(".rmd-list"),g=0;g<f.length;g++){for(var h=$(f[g]).attr("data-id"),i=!1,g=0;g<b.length;g++)if(b[g]==h){i=!0;break}i||b.push(h)}for(var j=0;j<e.length;j++){var h=$(e[j]).attr("data-id");$(e[j]).hasClass("MATERIAL")?c.push(h):$(e[j]).hasClass("SURFACE")&&d.push(h)}a.CurrentSelectStr={SERIES:b,MATERIAL:c,SURFACE:d}},saveRules:function(){var a=this;a.IsChanged&&(a.setDefaultRules(),a.RuleInfoVModel.setter(a.LoginUser.DDUserId,a.CurrentSelectStr.SERIES.join(),a.CurrentSelectStr.MATERIAL.join(),a.CurrentSelectStr.SURFACE.join()),a.RuleInfoVModel.setRulesInfo(function(b){0==b.Data.STATE&&(void 0!=$(".btn-modify")[0]?0==a.CurrentSelectRules.SERIES.length?$(".btn-deter").notify("您的关注品类修改成功","success"):$(".btn-modify").notify("您的关注品类修改成功！","success"):$(".btn-deter").notify("您的关注品类保存成功！","success"),$(a.LbRmdBefore).empty(),a.SeriesTemplate.tmpl(a.CurrentSelectRules).appendTo(a.LbRmdBefore),a.checkStates())}))}},j});