/*! bate version - v1.0 - vA packaged deploy by 冯达庆 . -2016-06-15 */;define(["jquery","jquerynotify","jquerytmpl","jqueryhisotry","NavibarCtl","../utils/SysUrl","../utils/Common","../utils/ConsumeLevel","../utils/SysConfig","../moduler/rs_QuotedInfo","../viewmodel/GoodsDealViewModel","../viewmodel/Require_QuoteViewModel","../viewmodel/CommentDealViewModel","../viewmodel/ContractInfoViewModel"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=function(b,c){this.tempPanel=a(".findD-none"),this.LeftPanel=a(".vien-left"),this.RightPanel=a(".vien-right"),this.lbDealtCount=a(".TotalDealt"),this.lbStartTime=a(".LbStartTime"),this.lbSeries=a(".LbSeries"),this.lbDetail=a(".LbDetail"),this.lbRCount=a(".LbRCount"),this.lbBCompany=a(".LbBCompany"),this.lbBContact=a(".LbBContact"),this.lbBUserTel=a(".LbBUserTel"),this.lbMinprice=a(".LbMinPrice"),this.lbMaxprice=a(".LbMaxPrice"),this.lbDealtPrice=a(".LbDealtPrice"),this.lbDescription=a(".LbDescription"),this.lbOfferCount=a(".LbOfferCount"),this.lbStartTime=a(".LbStartTime"),this.btnComment=a(".btn-Comment"),this.TotalViedSuccess=0,this.TmplRequireMarkUp=a("#VieSuccessTemplate"),this.BuyLevelMarkUp=a("#BuyLevelMarkUp"),this.RequireMarkUp=a(".VieSuccessMarkUp"),this.BuyerLevel=a(".BuyerLevel"),this.LoginUser=b,this.FindModel=new k,this.RequirePageNo=window.SysInfo.Paging.VisiblePages,this.RequirePageSize=window.SysInfo.Paging.DftPageSize,this.RequireDetailModel=new l,this.CurrentRequireID=null,this.CurrentOfferID=null,this.CommentModel=new m,this.ContractModel=new n,this.CurrentRequireLst=[],this.CurrentRequire={},this.IsFirstQuery=!0,this.navibar=new e(b),"undefined"!=typeof c&&(this.CurrentRequireID=c),this.init()};return o.prototype={init:function(){var b=this;"object"==typeof b.LoginUser&&void 0!=b.LoginUser||(window.location=f.getUrl("/Account/Login?ReturnUrl="+window.location.pathname)),b.navibar.buildNavibar(function(c){c.VICTORY>0&&0==c.STATE&&b.beginQuerySales(),0==c.VICTORY||0!=c.STATE?b.tempPanel.css("display","block"):(b.LeftPanel.css("display","block"),b.RightPanel.css("display","block")),b.navibar.buildScroll(),a(".TotalViedSuccess").first().closest("dd").addClass("active")}),History.pushState("","抢单- 抢单成功- 东方商城","/DGoods/VieOrder/ViedSuccess"),b.LeftPanel.empty(),b.CurrentRequireLst=[]},beginQuerySales:function(){var a=this;a.FindModel.setter(a.LoginUser.DDUserId,"S",a.RequirePageNo,a.RequirePageSize),a.FindModel.quoteGoods(function(b){if(1==b.isSuccess){for(var c=0;c<b.Data.DATAS.length;c++)b.Data.DATAS[c].ImageData={ImageLst:h(b.Data.DATAS[c].BCREDIT,!0)};if(b.Data.DATAS.length>0){if(1==a.IsFirstQuery){if(a.IsFirstQuery=!1,null!=a.CurrentRequireID)for(var c=0;c<b.Data.DATAS.length;c++)if(b.Data.DATAS[c].REQUIREID==a.CurrentRequireID){var d=b.Data.DATAS[c];b.Data.DATAS[c]=b.Data.DATAS[0],b.Data.DATAS[0]=d;break}b.Data.DATAS[0].ISACTIVE="active",a.CurrentRequire=b.Data.DATAS[0],a.CurrentRequireID=b.Data.DATAS[0].REQUIREID,a.beginQueryDetail()}a.CurrentRequireLst=a.CurrentRequireLst.concat(b.Data.DATAS),a.TmplRequireMarkUp.tmpl(b.Data.DATAS).appendTo(".vien-left"),a.bindLeftEvents(),a.setCurrent()}}else alert(b)})},setCurrent:function(){var a=this;a.BuyerLevel.empty(),a.BuyLevelMarkUp.tmpl(a.CurrentRequire.ImageData).appendTo(".BuyerLevel"),a.lbDescription.text(a.CurrentRequire.NOTE),a.lbSeries.text(a.CurrentRequire.SERIES+"/"+a.CurrentRequire.MATERIAL+"/"+a.CurrentRequire.SURFACE),a.lbDetail.text(a.CurrentRequire.DETAIL+"      交货地点:"+a.CurrentRequire.DELIVERY),a.lbBCompany.text(),a.lbRCount.text(),a.lbBContact.text(),a.lbBUserTel.text(),a.lbOfferCount.text(),a.lbDealtPrice.text(),a.lbStartTime.text(),a.lbMinprice.text(),a.lbMaxprice.text(),"Y"==a.CurrentRequire.SCOMMENTED?a.btnComment.css("display","none"):a.btnComment.css("display","block"),a.bindRightEvents()},beginQueryDetail:function(){function a(){c.lbOfferCount.text(c.CurrentRequire.Contract.OFFERS),c.lbDealtPrice.text(c.CurrentRequire.Contract.DEALPRICE),c.lbBCompany.text(c.CurrentRequire.Contract.BCOMPANY),c.lbBContact.text(c.CurrentRequire.Contract.BCONTACT),c.lbBUserTel.text(c.CurrentRequire.Contract.BTEL),c.lbMinprice.text(c.CurrentRequire.Contract.MINPRICE),c.lbMaxprice.text(c.CurrentRequire.Contract.MAXPRICE),c.lbRCount.text(c.CurrentRequire.Contract.BREQCOUNT)}function b(){c.lbStartTime.text(c.CurrentRequire.RequireDetail.PUBDATE)}var c=this;void 0==c.CurrentRequire.Contract?(c.ContractModel.setter(c.LoginUser.DDUserId,c.CurrentRequire.CONTRACTID),c.ContractModel.getContractInfo(function(b){b.isSuccess&&(c.CurrentRequire.Contract=b.Data,a())})):a(),void 0==c.CurrentRequire.RequireDetail?(c.RequireDetailModel.setter(c.LoginUser.DDUserId,c.CurrentRequire.REQUIREID),c.RequireDetailModel.getRequireDetail(function(a){a.isSuccess&&(c.CurrentRequire.RequireDetail=a.Data,b())})):b()},bindLeftEvents:function(){var b=this;b.LeftPanel.find("li").unbind("click"),b.LeftPanel.find("li").click(function(){b.LeftPanel.find("li").removeClass("active"),a(this).addClass("active"),b.CurrentRequire=j.Rsp,b.CurrentRequireID=a(this).attr("data-id");for(var c=0;c<b.CurrentRequireLst.length;c++)if(b.CurrentRequireLst[c].REQUIREID==b.CurrentRequireID){b.CurrentRequire=b.CurrentRequireLst[c];break}b.setCurrent(),b.CurrentRequire.REQUIREID.length>0&&b.beginQueryDetail()});var c=!1;b.TotalViedSuccess=parseInt(a(".TotalViedSuccess").last().text()),a(b.LeftPanel).scroll(function(){if(!c&&a(b.LeftPanel).scrollTop()>b.LeftPanel.prop("scrollHeight")-b.LeftPanel.height()-20&&(c=!0,b.TotalViedSuccess-b.CurrentRequireLst.length>0)){var d='<li class="loadMore" style="text-align:center;position:absolute;bottom: 21px;width: 54.4%;z-index: 100;background: white;">信息加载中...</li>';a(d).insertAfter(b.LeftPanel.find("li").last()),b.RequirePageNo+=1,b.beginQuerySales(),a(".loadMore").fadeOut(2e3,function(){a(this).remove()})}})},bindRightEvents:function(){var b=this;a(".btn-Comment").unbind("click"),a(".btn-Comment").on("click",function(c){a(this).closest("li");b.showdialog()})},showdialog:function(){var b=this;b.CurrentRequire.CommentScore=5;for(var c="",d=1;6>d;d++)c+='<div class="imag-comment '+d+'" data-score="'+d+'" ></div>';var e={title:"DD找货 评价买家",desc:'<div class="dialog-comment"><span class="desc-comment">综合评分：</span>'+c+"</div>",htmlTemplate:'<div class="msg body"><div class="msg body-note"> <textarea maxlength="300" placeholder="输入对买家的评价"  class="LbNote" rows=6 cols=60></textarea><span class="ex-word">最多只能输入300字</span></div><div class="msg body-states"><span class="txtStates">0/300</span></div>',button:{cleanBtn:{visable:!0,text:"取消",OnCancel:function(){}},enterBtn:{text:"提交",onConfrim:function(){b.CommentModel.setter(b.LoginUser.DDUserId,b.CurrentRequire.CONTRACTID,b.CurrentRequire.CommentScore,b.CurrentRequire.CommentTxt,"S"),b.CommentModel.sendcomment(function(c){0==c.Data.STATE?(g.WriteAnalyze("抢成功-评价",{"求购类型":b.CurrentRequire.SERIES,"成交价格":b.CurrentRequire.DEALPRICE}),a(".LbRCount").notify("对买家评价成功,积分+"+c.Data.SCORE,{position:"right",className:"success"}),b.btnComment.css("display","none"),b.CurrentRequire.SCOMMENTED="Y"):alert(c.Data.MSG)})}}}},f=new g.CustDialog(e);f.showNoCertDialog(),g.PlaceHolder(),b.eventMonitor()},eventMonitor:function(){function b(){var b=a(".LbNote").val();b.length>=300&&(a(".ex-word").show(),a(".LbNote").css("border","1px solid red"),a(".body-states").css("border","1px solid red"),a(".body-states").css("border-top","none"),a(".LbNote").val(a(".LbNote").val().substring(0,300))),b.length<300&&(a(".ex-word").hide(),a(".LbNote").css("border","1px solid #a9a9a9"),a(".body-states").css("border","1px solid #a9a9a9"),a(".body-states").css("border-top","none"))}var c=this;a(".dialog-comment").unbind("click"),a(".dialog-comment>.imag-comment").click(function(){a(".dialog-comment>.imag-comment").each(function(b,c){a(c).css("background-image","url(/Content/Users/DGoods/Images/star-gray.png)")});for(var b=parseInt(a(this).attr("data-score")),d=a(this).parent(),e=1;b+1>e;e++)d.find(".imag-comment."+e.toString()).css("background-image","url(/Content/Users/DGoods/Images/star_yellow.png)");c.CurrentRequire.CommentScore=b}),a(".LbNote").unbind("keyup"),a(".LbNote").keyup(function(d){if(b(),a(this).val()>300)return!1;c.CurrentRequire.CommentTxt=a(this).val();var e=c.CurrentRequire.CommentTxt.toString().length;a(".txtStates").text(e.toString()+"/300")})}},o});